@model FOS.Shared.RetailerData
@{
    ViewBag.Title = "Add Site";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<style>
    .table-responsive {
        display: block;
        width: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="~/Content/Style/UploadPhoto.css" rel="stylesheet" />
@*<script src="https://maps.googleapis.com/maps/api/js"></script>*@
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7X3GhN_ShrwYqU1Wc0gJbX3CMOMPZIs4"></script>

<br />
<div class="row-fluid">
    <div class="span12">
        <div class="widget green">
            <div class="widget-title">
                <h4 class="text-center"><strong>Add New Site</strong></h4>
            </div>
            <div class="widget-body" style="">
                <div>
                    <form class="form-horizontal form-label-left" style="margin-top: -16px;">
                        <input id="ID" name="ID" type="hidden" value="0">

                        <div class="form-group">
                            <div class="span12">
                                <div class="span3" style="margin-top: 0px;">
                                    <div class="control-group" style=" margin-bottom: 10px;">
                                        <label class="control-label">Select Client:*</label>
                                        <div class="controls" style="float: left; margin-left: auto;">
                                            @Html.DropDownListFor(model => model.ClientID, new SelectList(Model.Client, "ID", "Name"), new { @class = "" })
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label">Select Project:*</label>
                                        <div class="controls" style="margin-left: 0px">
                                            @Html.DropDownListFor(model => model.SaleOfficerID, new SelectList(Model.Projects, "ID", "Name"), new { @class = "" })
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label">Select Zone:*</label>
                                        <div class="controls" style="margin-left: 0px">
                                            @Html.DropDownListFor(model => model.CityID, new SelectList(Model.Cities, "ID", "Name"), new { @class = "" })
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label">Select Town:*</label>
                                        <div class="controls" style="margin-left: 0px">
                                            @Html.DropDownListFor(model => model.AreaID, new SelectList(Model.Areas, "ID", "Name"), new { @class = "Areas" })
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label">Select Sub Division:*</label>
                                        <div class="controls" style="margin-left: 0px">
                                            @Html.DropDownListFor(model => model.SubDivisionID, new SelectList(Model.SubDivisions, "ID", "Name"), new { @class = "Areas" })
                                        </div>
                                    </div>
                                </div>
                                <div class="span3" style="margin-top: 0px;">
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label" style="">Site Name:*</label>
                                        <div class="controls" style="margin-left: 0px">
                                            <input class="text-box single-line" autocomplete="off" id="Name" name="Name" type="text" value="" placeholder="Enter Site Name:">
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label" style="">Site Code:*</label>
                                        <div class="controls" style="margin-left: 0px">
                                            <input class="text-box single-line" autocomplete="off" id="RetailerCode" name="RetailerCode" type="text" value="" placeholder="Enter Site Code:">
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label" style="">Capacity:</label>
                                        <div class="controls" style="margin-left: 0px">
                                            <input class="text-box single-line" autocomplete="off" id="Capacity" name="Capacity" type="text" value="" placeholder="Enter Site's Capacity:">
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label" style="">SWL:</label>
                                        <div class="controls" style="margin-left: 0px">
                                            <input class="text-box single-line" autocomplete="off" id="SWL" name="SWL" type="text" value="" placeholder="Enter Site's SWL:">
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label" style="">Year Of Installation:</label>
                                        <div class="controls" style="margin-left: 0px">
                                            <input class="text-box single-line" autocomplete="off" id="Year_of_In" name="Year_of_In" type="text" value="" placeholder="Enter Site's Year Of Installation:">
                                        </div>
                                    </div>
                                </div>
                                <div class="span3" style="margin-top: 0px;">
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label" style="">Latitude:</label>
                                        <div class="controls" style="margin-left: 0px">
                                            <input class="text-box single-line" autocomplete="off" id="Latitude" name="Latitude" type="text" value="" placeholder="Enter Site's Latitude:">
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label" style="">Longitude:</label>
                                        <div class="controls" style="margin-left: 0px">
                                            <input class="text-box single-line" autocomplete="off" id="Longitude" name="Longitude" type="text" value="" placeholder="Enter Site's Longitude:">
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label" style="">Contact No:</label>
                                        <div class="controls" style="margin-left: 0px">
                                            <input class="text-box single-line" autocomplete="off" id="Phone1" name="Phone1" type="text" value="" placeholder="Enter Site's Contact No:">
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 10px">
                                        <label class="control-label" style="">Address:</label>
                                        <div class="controls" style="margin-left: 0px">
                                            <textarea class="control-label" cols="20" id="Address" name="Address" rows="2" style="width:201px;resize: none;height:90px;color: #333;" placeholder="Enter Site's Address:"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="span3" style="margin-top: 0px;">
                                    <div class="user-profile-image">
                                        <input type="file" name="Picture1" style="display:none" ; class="hidden" id="Picture1" />
                                        <img src="/Images/no-image-available.png.jpg" class="img-responsive" id="UserImage" />
                                        <div class="upload-photo">
                                            <img src="/Images/upload.png" class="img-responsive" />
                                        </div>
                                        <div class="remove-photo">
                                            <span class="fa fa-window-close"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="span12" style="margin-left:0px;">
                                <hr />

                                <div class="control-group" style="display: flex; align-items: center; justify-content: center;">
                                    <hr />
                                    <hr />
                                    <button class="btn btn-primary" id="create" style="margin-right: 9px;"><i class="icon-ok icon-white"></i><strong> Create</strong></button>
                                    <button class="btn btn-info" id="btnRefresh"><i class="icon-ban-circle icon-white"></i><strong> Reset</strong></button>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>
            </div>

        </div>
        <!-- END EXAMPLE TABLE widget-->
    </div>
</div>
<div class="row-fluid">
    <div class="span12">
        <div class="widget green">
            <div class="widget-title">
                <h4 class="text-center"><strong>All Sites Detail</strong></h4>
            </div>
            <div class="widget-body">
                <div>
                    <div class="space15"></div>
                    <div class="table-responsive">
                        <table class="table table-striped  table-hover table-bordered" id="datatab" style="width: 100%;">
                            <thead>
                                <tr class="align-center" style="background-color:#1969b1; color:white;">
                                    <th>Sr No</th>
                                    @* <th>Client</th>
                    <th>Created At</th>
                    <th>Updated At</th>
                     <th>Capacity</th>
                     <th>SWL</th>
                     <th>Y-O-I</th>
                     <th>Contact No</th>
                     <th>Address</th>*@
                                    <th>Project</th>
                                    <th>Zone</th>
                                    <th>Town</th>
                                    <th>Subdivision</th>
                                    <th>Site Name</th>
                                    <th>Site Code</th>
                                    <th>Latitude</th>
                                    <th>Longitude</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <br />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>



    $(function () {
        $("#create").click(function () {
                var data = new FormData();
                var files = $("#Picture1").get(0).files;
                if (files.length > 0) {
                    data.append("Picture1", files[0]);
            }
                data.append("ID", $("#ID").val());
                data.append("ClientID", $("#ClientID").val());
                data.append("SaleOfficerID", $("#SaleOfficerID").val());
                data.append("CityID", $("#CityID").val());
                data.append("AreaID", $("#AreaID").val());
                data.append("SubDivisionID", $("#SubDivisionID").val());
                data.append("Name", $("#Name").val());
                data.append("RetailerCode", $("#RetailerCode").val());
                data.append("Capacity", $("#Capacity").val());
                data.append("SWL", $("#SWL").val());
                data.append("Year_of_In", $("#Year_of_In").val());
                data.append("Latitude", $("#Latitude").val());
                data.append("Longitude", $("#Longitude").val());
                data.append("Phone1", $("#Phone1").val());
                data.append("Address", $("#Address").val());
                var settings = {
                    type: "Post",
                    url: "/Retailer/NewUpdateRetailer",
                    contentType: false,
                    processData: false,
                    cache: false,
                    data: data,
                    success: function (result)
                    {
                        if (result == 0){alertify.error("Unable To Save Site data.Verify All Compulsory Fields");}
                        if (result == 1){alertify.error("Unable To Save Site data.The Field Capacity Must be Number ");}
                        if (result == 2){alertify.error("Unable To Save Site data.The Field SWL Must be Number or Decimal Number ");}
                       // if (result == 3){alertify.error("Unable To Save Site data.The Field YOI be Number ");}
                        if (result == 4){alertify.error("Unable To Save Site data.The Field Longitude Must be Decimal Number ");}
                        if (result == 5){alertify.error("Unable To Save Site data.The Field Latitude Must be  Decimal Number "); }
                        if (result == 6) { alertify.error("Unable To Save Site data.Retailer Code already Exist "); }
                        if (result == 7)
                        {
                            alertify.success("Site Added Successfully.");
                            $('#create').text('Create');
                            ClearForm();
                            var dt = $('#datatab').DataTable();
                            dt.ajax.reload();
                        }
                        if (result == 8) {
                            alertify.success("Site Updated Successfully!");
                            $('#create').text('Create');
                            ClearForm();
                            var dt = $('#datatab').DataTable();
                            dt.ajax.reload();
                        }
                        $(".loader").hide();
                        $(window).load(function () {
                            $(".loader").fadeOut("fast");
                        })
                    }
                    
                };
                $.ajax(settings);
                return false;
        });
    });

    function GenerateDetailGrid() {

        var oTable = $('#datatab').DataTable({
            "aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
            "iDisplayLength": 10,
            "paging": true,
            "pagingType": "full_numbers",
            "serverSide": true,
            "bRetrieve": true,
            "bDestroy": true,
            "autoWidth": true,
            "ajax":
            {
                "type": "POST",
                "url": '@Url.Action("AllSitesData", "Retailer")',
                "contentType": 'application/json; charset=utf-8',
                'data': function (data)
                {
                    data.ProjectId = $('#SaleOfficerID').val();
                    return data = JSON.stringify(data);
                },
            },    
                "fnDrawCallback": function (osetting) {

                var UpdateCheck = "0";
                var DeleteCheck = "0";

                if (UpdateCheck == "@HttpContext.Current.Session["UpdateCheck"]") { $(".edit").css("display", "none"); }
                else {
                    $(".edit").on("click", function () {

                        ClearForm();
                        $('#create').text('Update');

                        var SiteID = $(this).attr("data-id");

                        try
                        {
                            $.ajax({
                                type: "POST",
                                url: "@Url.Action("GetEditSites", "Retailer")",
                                data: { SiteID: SiteID },

                                success: function (Response) {
                                    debugger;
                                    if (Response != null) {
                                        $('#ID').val(Response.ID);
                                        $("#ClientID").val(Response.RegionID);
                                        $("#SaleOfficerID").val(Response.ZoneID);
                                        $("#CityID").val(Response.CityID);
                                        $("#AreaID").val(Response.AreaID);
                                        $("#SubDivisionID").val(Response.SubDivisionID);
                                        $("#Name").val(Response.Name);
                                        $("#RetailerCode").val(Response.RetailerCode);
                                        $("#Capacity").val(Response.Capacity);
                                        $("#Year_of_In").val(Response.Year_of_In);
                                        $("#SWL").val(Response.SWL);
                                        $("#Latitude").val(Response.Latitude);
                                        $("#Longitude").val(Response.Longitude);
                                        $("#Phone1").val(Response.Phone1);
                                        $("#Address").val(Response.Address);
                                        $("#Picture").val(Response.Picture1); 
                                        if (Response.Picture1 != null)
                                        {
                                            $("#UserImage").attr('src', Response.Picture1);
                                        }
                                        else if (Response.Picture1 == null || Response.Picture1 == "")
                                        {
                                            $("#UserImage").attr('src',"/Images/no-image-available.png.jpg");
                                            $("#Picture").val(); 
                                        }

                                        $('html, body').animate({
                                            scrollTop: $("#main-content").offset().top
                                        }, 500);

                                        $("#UserImage").focus();

                                    }
                                    else { alertify.error('Server Is Not Responding.'); }
                                }
                            });
                        }
                        catch (ex) { }

                    });
                }

                if (UpdateCheck == "@HttpContext.Current.Session["DeleteCheck"]") { $(".delete").css("display", "none"); }
                    else {
                        $(".delete").on("click", function () {

                            var SiteID = $(this).attr("data-id");

                            // confirm dialog
                            alertify.confirm("Are You Sure You Want To Delete This Record ?  ", function (e) {
                                if (e) {
                                    $.ajax({
                                        type: "POST",
                                        url: "@Url.Action("DeleteSiteData", "Retailer")",
                                        data: { SiteID: SiteID },
                                        success: function (data) {

                                            if (data == "0") {
                                                alertify.success('Record Deleted Successfully');
                                                var table = $('#datatab').DataTable();
                                                table.row(this).remove().draw(false);
                                            }
                                        }

                                    });

                                } else { }
                            });

                        });
                    }

                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                    $("td:first", nRow).html(iDisplayIndex + 1);
                    return nRow;
                },
                "oLanguage": { "sSearch": "Search Site : " },
                "sDom": 'lftipr',
                "deferRender": true,
                "bSelect": true,
                "columns": [
               { "data": "ID" , "sClass": "center-align-td"},
               { "data": "ZoneName" ,"sClass": "center-align-td"},
               { "data": "CItyName", "sClass": "center-align-td" },
               { "data": "AreaName", "sClass": "center-align-td" },
               { "data": "SubDivisionName", "sClass": "center-align-td" },
               { "data": "Name", "sClass": "center-align-td" },
               { "data": "RetailerCode", "sClass": "center-align-td" },
               { "data": "Latitude", "sClass": "center-align-td" },
               { "data": "Longitude", "sClass": "center-align-td" },
               {
                   "sClass": "center-align-td",
                   "mData": null,
                   "bSortable": false,
                   "mRender": function (data, type, row) {
                       return '<button class="btn btn-success edit" data-id=' + row.ID + '>' + '<i class=icon-pencil></i>' + '</button>&nbsp;<button class="btn btn-info delete" data-id=' + row.ID + '>' + '<i class=icon-trash></i>' + '</button>';
                   }
               }
                ],
                "order": [0, "desc"]

            });

        }





    $(document).ready(function () {

        GenerateDetailGrid();
        $("#liRetailer,#liManageRetailer").addClass("active");

        var WriteCheck = "0";

        if (WriteCheck == "@HttpContext.Current.Session["WriteCheck"]") {
             $("#create").css("display", "none");
        }
        else {
        }

        function LoadCities(RegionalHeadID) {
        debugger;
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetZoneList", "Dealer")",
            data: { RegionID: RegionalHeadID },
            success: function (json) {

                var $el = $("#CityID");
                $el.empty(); // remove old options
                $.each(json, function (value, key) {
                    $el.append($("<option></option>").val(key.ID).text(key.Name));
                });

                var $el = $("#AreaID");
                $el.empty(); // remove old options

                $("#CityID option:first").trigger("change");
                // GetAreaList($("#CityID option:first").val());
            }
        });
    }
        function LoadAreas(CityID) {
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetAreaListByCityID", "Dealer")",
            data: { CityID: CityID == null ? 0 : CityID },
            success: function (json) {

                var $el = $("#AreaID");
                $el.empty(); // remove old options
                $.each(json, function (value, key) {
                    $el.append($("<option></option>").val(key.ID).text(key.Name));
                });
            }

        });
    }
        function LoadSubDivision(CityID) {
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetSubDivisionListByAreaID", "Dealer")",
            data: { CityID: CityID == null ? 0 : CityID },
            success: function (json) {

                var $el = $("#SubDivisionID");
                $el.empty(); // remove old options
                $.each(json, function (value, key) {
                    $el.append($("<option></option>").val(key.ID).text(key.Name));
                });
            }

        });
    }
        function LoadProjects(ClientID) {

            try {
                $.ajax({
                    type: "POST",
                    data: { RegionalHeadID: ClientID },
                    url: "@Url.Action("GetAllProjects", "Job")",
                    success: function (json) {

                        var $el = $("#SaleOfficerID");
                        $el.empty(); // remove old options
                        $.each(json, function (value, key) {
                            $el.append($("<option></option>")
                                .val(key.ID).text(key.Name));
                        });
                    }

                });
            } catch (e) {
            }

        }
        @*function LoadDealers(RegionalHeadID) {

            try {
                $.ajax({
                    type: "POST",
                    data: { RegionalHeadID: RegionalHeadID },
                    url: "@Url.Action("GetAllDealersListRelatedToRegionalHead", "Dealer")",
                    success: function (json) {

                        var $el = $("#DealerID");
                        $el.empty(); // remove old options
                        $.each(json, function (value, key) {
                            $el.append($("<option></option>")
                                    .val(key.ID).text(key.Name));
                        });
                    }

                });
            } catch (e) {
            }

        }*@
        $("#ClientID").change(function () {
            LoadProjects($(this).val());
        });
        $("#SaleOfficerID").change(function () {
            LoadCities($(this).val());
            GenerateDetailGrid();
        });
        $("#CityID").change(function () {
            LoadAreas($(this).val());
        });
        $("#AreaID").change(function () {
            LoadSubDivision($(this).val());
        });
        $("#btnRefresh").click(function () {
            ClearForm();
        });

    });

    function ClearForm() {
        $('#ID').val(0);
        $('#RegionID').val(0);
        $('#ZoneID').val(0);
        $('#CityID').val(0);
        $('#AreaID').val(0);
        $('#SubDivisionID').val(0);
        $('#Name').val('');
        $('#RetailerCode').val('');
        $('#Capacity').val('');
        $('#SWL').val('');
        $('#Year_of_In').val('');
        $('#Latitude').val('');
        $('#Longitude').val('');
        $('#Address').val('');
        $('#Phone1').val('');
        $('#LandLineNo').val('');
        $('#Picture1').val('');
        $('#SaleOfficerID').val(0);
        $("#UserImage").attr('src', "/images/no-image-available.png.jpg");
    }

    //Upload-Picture

    $('#UserImage').click(function () {
        UploadClickEvent();
    });
    $('.upload-photo').click(function () {
        UploadClickEvent();
    });
    function UploadClickEvent() {
        $('#Picture1').trigger('click');
    }
    $('#Picture1').change(function () {
        if (this.files && this.files[0]) {
            var fileReader = new FileReader();
            fileReader.readAsDataURL(this.files[0]);
            fileReader.onload = function (x) {
                $('#UserImage').attr('src', x.target.result);

            }
        }

    });
    $('.remove-photo').click(function () {
        $('#UserImage').attr('src', "/images/no-image-available.png.jpg");

    });

</script>